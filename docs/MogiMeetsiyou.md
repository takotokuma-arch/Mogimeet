# **MogiMeet：完全開発仕様書 目次**

1. **プロジェクト概要**  
   * コンセプト・名称・開発目標  
2. **技術スタックとインフラ構成**  
   * 使用フレームワーク・外部サービス・接続情報  
3. **データベース設計（SQLスキーマ）**  
   * 各テーブルの定義とリレーション  
4. **デザインシステムとUIガイドライン**  
   * カラーパレット・タイポグラフィ・共通パーツ・基本スタイル  
5. **共通レイアウトとグローバルUI**  
   * ヘッダー・サイドバー・レスポンシブ要件  
6. **機能詳細 1：イベント作成フロー（/create）**  
   * 入力項目・特定日付選択カレンダー・作成完了モーダル  
7. **機能詳細 2：回答グリッド画面（/events/\[id\]）**  
   * チェックインモーダル・グリッド表示・ヒートマップロジック  
8. **技術仕様：グリッド操作ロジック**  
   * Pointer Events・スクロール制御・ハプティクスフィードバック  
9. **機能詳細 3：管理者用設定パネル**  
   * Discord連携設定・通知トグル・リマインドスケジューラー  
10. **機能詳細 4：予定確定（ピンクモード）と再編集**  
    * 矩形選択UI・マッチング集計・再確定フロー  
11. **機能詳細 5：確定後のおもてなしと外部連携**  
    * カレンダー登録・コピー用テキスト生成・確定用Discord Embed  
12. **通知・自動化システム**  
    * Discord Webhook・リマインド用API・Cron連携  
13. **AIへの実装ステップ指示（ロードマップ）**  
    * 優先順位・フェーズ分け

# **1\. プロジェクト概要**

## **1.1 アプリケーション名称**

* **名称:** MogiMeet (モギミート)

## **1.2 コンセプトと目的**

* **モデル:** グループ日程調整サービス「Lettucemeet」および「When2Meet」のグリッドUIをモデルとした、モダンなスケジューリングツール。  
* **目的:** ログインやアカウント作成という障壁を排除し、URLを共有するだけで「なぞって回答」できる直感的なインターフェースを提供することで、日程調整のスピードを最大化する。  
* **コア体験:** 参加者の可用性（Availability）を2次元グリッド上に重ね合わせ、最適解を視覚的に特定することに特化する。

## **1.3 デザインフィロソフィ**

* **ミニマリズム:** 白を基調としたクリーンなデザイン。AppleやNotionのような「静かで機能的」な美しさを追求する。  
* **直感性:** 説明不要で操作が理解できるUI。余計なアニメーションや演出を排除し、データの視認性と操作の軽快さを最優先する。

## **1.4 開発・運用の技術目標**

* **完全無料枠での永続運用:** クレジットカード登録が不要な Supabase Free Tier および Vercel Hobby Plan を前提に設計し、個人の開発者や学生でもノーリスクで公開・運用可能にする。  
* **通知システムの自律化:** Discord Webhook と外部スケジューラー（cron-job.org）を組み合わせ、サーバーレス環境でも自動リマインドや通知を確実に動作させる。

## **1.5 期待される成果**

* 複数人の予定がリアルタイムにヒートマップとして可視化されることで、主催者の意思決定を迅速にする。  
* 特定の期間・時間枠に特化した調整により、ゼミ、サークル、友人間の集まり、ビジネスミーティングなど幅広いシーンで活用できる柔軟性を持たせる。

# **2\. 技術スタックとインフラ構成**

## **2.1 フロントエンド**

* **Framework:** Next.js 14+ (App Router)  
* **Styling:** Tailwind CSS  
* **UI Components:** shadcn/ui (Radix UI ベース)  
* **Icons:** Lucide React  
* **State Management:** React Context API / Zustand (ドラッグ状態管理用)  
* **Animations:** Framer Motion (モーダル・トースト表示用)

## **2.2 バックエンド・データベース**

* **BaaS:** Supabase  
* **Database:** PostgreSQL (Row Level Security を有効化)  
* **Authentication:** 不要（トークンベースのアクセス制御）  
* **接続情報:**  
  * **Project URL:** https://ulibgutnhdwueqwgymwk.supabase.co  
  * **Anon Key:** sb\_publishable\_bC1LDvdhIBMRwRb1-RCFdA\_SYOA70Xh

## **2.3 通知・自動化**

* **Notification:** Discord Webhook API  
* **Scheduler:** cron-job.org (外部からの定期実行トリガー)

## **2.4 インフラ・ホスティング**

* **Deployment:** Vercel (Hobby Plan)  
* **Source Control:** GitHub

## **2.5 環境変数 (.env.local / Vercel)**

* NEXT\_PUBLIC\_SUPABASE\_URL: Supabase プロジェクトURL  
* NEXT\_PUBLIC\_SUPABASE\_ANON\_KEY: Supabase 匿名キー  
* CRON\_SECRET: cron-job.org からのリクエストを検証するための秘密鍵

# **3\. データベース設計（SQLスキーマ）**

タイムゾーンの不一致によるトラブルを完全に防ぐため、すべての日時データには TIMESTAMP WITH TIME ZONE (TIMESTAMPTZ) を使用します。また、管理者の再編集や予定確定（ピンクモード）をサポートするための拡張的なカラムを含みます。

## **3.1 テーブル定義**

### **3.1.1 events テーブル**

イベントの基本情報、管理者権限、およびグローバルな設定を保持します。

SQL

CREATE TABLE events (

  id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),

  admin\_token UUID NOT NULL DEFAULT gen\_random\_uuid(), \-- 管理者専用URL用トークン

  title TEXT NOT NULL,

  description TEXT,


  \-- グリッド設定

  slot\_interval INTEGER NOT NULL DEFAULT 30, \-- 15, 30, 60 (分)

  display\_start\_time TIME NOT NULL DEFAULT '09:00', \-- デフォルト表示開始

  display\_end\_time TIME NOT NULL DEFAULT '23:00', \-- デフォルト表示終了


  \-- 通知・管理設定

  webhook\_url TEXT, \-- Discord Webhook URL

  is\_notify\_confirmed BOOLEAN DEFAULT TRUE, \-- 確定時通知

  is\_notify\_updated BOOLEAN DEFAULT TRUE, \-- 更新時通知

  reminder\_hours INTEGER, \-- 締切の何時間前に通知するか

  deadline\_at TIMESTAMP WITH TIME ZONE, \-- 回答締め切り日時


  \-- 確定済み予定（ピンクモード用）

  confirmed\_start\_at TIMESTAMP WITH TIME ZONE,

  confirmed\_end\_at TIMESTAMP WITH TIME ZONE,


  created\_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()

);

### **3.1.2 time\_slots テーブル**

主催者がカレンダーで選択した特定の日付に基づき、グリッドの最小単位となる時間枠を格納します。

SQL

CREATE TABLE time\_slots (

  id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),

  event\_id UUID REFERENCES events(id) ON DELETE CASCADE,

  start\_at TIMESTAMP WITH TIME ZONE NOT NULL, \-- スロット開始日時


  UNIQUE(event\_id, start\_at) \-- 同一イベント内での重複防止

);

### **3.1.3 responses テーブル**

回答者の個人情報を保持します。ログイン不要を実現するため、ブラウザ指紋を使用します。

SQL

CREATE TABLE responses (

  id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),

  event\_id UUID REFERENCES events(id) ON DELETE CASCADE,

  user\_name TEXT NOT NULL, \--

  user\_fingerprint TEXT NOT NULL, \-- LocalStorage保存用の匿名ID

  is\_admin BOOLEAN DEFAULT FALSE, \-- 管理者バッジ表示用

  created\_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()

);

### **3.1.4 availability テーブル**

各回答者と各時間枠の紐付け（「空き」の状態）を管理する中間テーブルです。

SQL

CREATE TABLE availability (

  response\_id UUID REFERENCES responses(id) ON DELETE CASCADE,

  time\_slot\_id UUID REFERENCES time\_slots(id) ON DELETE CASCADE,


  PRIMARY KEY (response\_id, time\_slot\_id) \-- 複合主キー

);

## **3.2 インデックス設計**

クエリの高速化（特にヒートマップの集計）のために以下のインデックスを推奨します。

* CREATE INDEX idx\_availability\_time\_slot ON availability(time\_slot\_id);  
  * 特定の時間枠に誰が空いているかを集計する際に使用。  
* CREATE INDEX idx\_time\_slots\_event ON time\_slots(event\_id, start\_at);  
  * イベントページ読み込み時にグリッドを描画するために使用。

## **3.3 リレーションシップ図**

1. **Events (1) ↔ TimeSlots (N):** 主催者が選んだ日付に基づき生成される枠。  
2. **Events (1) ↔ Responses (N):** イベントに紐づく参加者。  
3. **Responses (1) ↔ Availability (N):** 参加者が「可」とした枠の記録。  
4. **TimeSlots (1) ↔ Availability (N):** その枠を「可」とした全参加者の集計。

# **4\. デザインシステムとUIガイドライン**

「MogiMeet」のアイデンティティを定義するデザインシステムです。Apple、Notion、LinearなどのモダンなSaaS製品が採用している、\*\*「清潔感」「機能的」「ノイズの少なさ」\*\*を最優先したライトモード（白ベース）のガイドラインです。

---

## **4.1 カラーパレット**

すべての色は Tailwind CSS の標準パレットに基づき、セマンティックな意味を持たせます。

### **4.1.1 ベースカラー（Base）**

* **Background:** white (\#FFFFFF) \- メイン背景。  
* **Surface:** slate-50 (\#F8FAFC) \- セクションの区切りや、背景とカードを分離するためのサブ背景。  
* **Border:** slate-200 (\#E2E8F0) \- 1pxの極細線で使用。情報の境界線を定義。

### **4.1.2 アクセントカラー（Accent）**

* **Primary (Availability):** emerald-500 (\#10B981)  
  * 用途: 自分の回答、ボタン、ヒートマップの最大値。  
  * ヒートマップ表現: 人数に応じて emerald-500 の不透明度（Opacity）を 10% から 90% まで変動させる。  
* **Secondary (Finalize):** pink-500 (\#EC4899)  
  * 用途: 管理者による予定確定（ピンクモード）のオーバーレイ。  
  * 不透明度: グリッド上に重ねる際は bg-pink-500/40 を使用し、下の文字やエメラルド色が透けて見えるようにする。

### **4.1.3 タイポグラフィ（Text）**

* **Main Text:** slate-900 (\#0F172A) \- 高いコントラストを保ちつつ、目に優しい深いグレー。  
* **Muted Text:** slate-500 (\#64748B) \- 注釈、プレースホルダー、非アクティブ状態。

---

## **4.2 タイポグラフィ**

モダンなサンセリフ体を使用し、情報の階層を明確にします。

* **Font Family:** Inter, system-ui, \-apple-system, sans-serif  
* **Heading 1:** text-3xl font-bold tracking-tight (イベント名など)  
* **Heading 2:** text-xl font-semibold (セクション見出し)  
* **Body:** text-sm font-normal (基本テキスト・グリッド内)  
* **Mono:** font-mono (時間表示や数値)

---

## **4.3 共通パーツのスタイル定義（shadcn/ui カスタマイズ）**

### **4.3.1 角丸設定（Border Radius）**

* **Standard:** rounded-2xl (16px) \- メインカード、モーダル。  
* **Button/Input:** rounded-xl (12px) \- インタラクティブ要素。  
* **Grid Cell:** rounded-sm (2px) \- グリッドの各コマ。

### **4.3.2 影と浮遊感（Elevation）**

* **Card:** shadow-sm border border-slate-200 \- 控えめな境界線と影。  
* **Modal/Pop-up:** shadow-xl ring-1 ring-slate-900/5 \- 強い浮遊感を持たせ、最前面であることを強調。

---

## **4.4 インタラクション・ステート**

ユーザーの操作に対する視覚的フィードバックの定義です。

* **Hover:** bg-slate-100 またはアクセントカラーの明度を 10% 上げる。  
* **Active (Click/Press):** scale-95 \- ボタンなどを押した際にわずかに縮小するアニメーション。  
* **Dragging (Grid):**  
  * 選択中のセルは ring-2 ring-emerald-400 で強調。  
  * スマホ操作時は、ドラッグ中の座標にあるセルの背景色をリアルタイムに反映。  
* **Disabled:** opacity-50 grayscale \- 締め切り後の回答不可状態など。

---

## **4.5 アイコンセット**

* **Library:** Lucide React  
* **Size:** 基本 18px (size-4.5)  
* **Stroke Width:** 2px (デフォルト)

---

## **4.6 共通アニメーション（Framer Motion）**

* **Modal:** initial: { opacity: 0, scale: 0.95 }, animate: { opacity: 1, scale: 1 }  
* **List Item:** initial: { x: \-10, opacity: 0 }, animate: { x: 0, opacity: 1 }  
* **Transition:** type: "spring", stiffness: 300, damping: 30 (心地よい弾力性のある動き)

---

# **5\. 共通レイアウトとグローバルUI**

「MogiMeet」のすべての画面で一貫した操作感と視覚的秩序を維持するための、大枠のレイアウト構造と共通UIコンポーネントの定義です。

---

## **5.1 グローバル・ヘッダー (Header)**

全ページ上部に固定されるナビゲーションエリアです。

* **スタイル:**  
  * sticky top-0 z-50 w-full  
  * bg-white/80 backdrop-blur-md (背景を透過させることでモダンな質感を演出)  
  * border-b border-slate-200  
* **左側 (Logo/Home):**  
  * 「MogiMeet」のロゴ。font-bold tracking-tighter text-xl。  
  * エメラルドグリーンの小さなドットアイコンを横に配置。  
* **中央 (Title):**  
  * 現在表示しているイベント名。text-sm font-medium text-slate-500。  
  * モバイル時は省略可。  
* **右側 (Status/Action):**  
  * 管理者の場合は text-pink-500 bg-pink-50 px-2 py-0.5 rounded text-xs font-bold で「ADMIN」と表示。  
  * ログイン不要だが、回答済みブラウザの場合はユーザー名の頭文字アイコン（Avatar）を表示。

---

## **5.2 サイドバー (Responder Sidebar)**

PC表示において、回答者の状況やサマリーを表示する固定エリアです。

* **スタイル:**  
  * w-64 border-r border-slate-200 bg-slate-50/50 hidden md:flex flex-col  
* **コンテンツ:**  
  * **参加者リスト:** scroll-area を使用。各ユーザーを Avatar と Name のセットで表示。  
  * **管理バッジ:** 主催者の名前の横には「👑」または「Admin」バッジを表示。  
  * **リアルタイム集計:** 「回答数：◯ / ◯人」の進捗表示。  
  * **共有リンク:** サイドバー下部に「招待URLをコピー」ボタンを常設。

---

## **5.3 モバイル用ドロワー (Mobile Drawer)**

画面幅が狭い（md 未満）場合、サイドバーの情報は下からスライドするドロワーに格納します。

* **トリガー:** ヘッダーの「参加者数」バッジをタップ。  
* **挙動:** shadcn/ui の Drawer コンポーネントを使用し、スマホの親指操作でリストを確認できるようにします。

---

## **5.4 メイン・コンテンツ・ラッパー (Main Layout)**

ページごとの主要な内容を表示する領域です。

* **スタイル:**  
  * flex-1 relative bg-white  
* **イベント作成画面 (/create):**  
  * max-w-2xl mx-auto py-12 px-6 (中央寄せのフォーム形式)  
* **回答グリッド画面 (/events/\[id\]):**  
  * h-\[calc(100vh-theme(spacing.16))\] (ヘッダーを除いた全画面を使用し、グリッド自体のスクロールを許容)

---

## **5.5 フローティング・アクションバー (Action Bar)**

特にモバイルにおいて、重要なアクション（保存、コピー、確定）を常に手の届く位置に置くためのUIです。

* **スタイル:**  
  * fixed bottom-6 left-1/2 \-translate-x-1/2 z-40  
  * bg-white/90 backdrop-blur border border-slate-200 shadow-lg rounded-full px-6 py-3 flex items-center gap-4  
* **要素:**  
  * 回答画面では「名前入力の状態」と「保存ボタン」。  
  * 確定画面では「確定範囲の選択状況」と「確定実行ボタン」。

---

## **5.6 共通フィードバック UI**

### **5.6.1 トースト通知 (Sonner)**

* **成功 (Success):** emerald-500 のアイコン。「コピー完了」「保存しました」など。  
* **エラー (Error):** red-500 のアイコン。「名前を入力してください」「通信エラー」など。

### **5.6.2 ローディング状態 (Skeleton)**

* データのフェッチ中、グリッドやリストの形に合わせた bg-slate-100 animate-pulse を表示し、レイアウトシフトを防ぎます。

---

次は **6\. 機能詳細 1：イベント作成フロー（/create）** の詳細を作成しますか？

# **6\. 機能詳細 1：イベント作成フロー（/create）**

主催者が最小限の入力でイベントを立ち上げられるよう、ステップ形式に近い「情報の論理的グループ化」を行った単一画面レイアウトです。

---

## **6.1 画面レイアウト構成**

* **全体構造:** 中央寄せのシングルカラム（max-w-2xl）。  
* **ビジュアル:** 背景は white、各セクションは slate-50 の背景を持つ Card コンポーネントで区切ります。

---

## **6.2 セクション別詳細**

### **6.2.1 基本情報入力 (Section 1\)**

* **イベント名 (title):**  
  * Input コンポーネント。大きく表示し、プレースホルダーは「例：年越し鍋パーティー」。  
* **説明文 (description):**  
  * Textarea コンポーネント。自動リサイズ（Auto-resize）機能を持ち、場所の候補や会費などの補足情報を記述。

### **6.2.2 候補日の選択 (Section 2 \- Core)**

* **カレンダーUI:**  
  * react-day-picker (shadcn/ui の Calendar) を使用。  
  * **モード:** mode="multiple" を採用し、特定の日付（22日、24日など）を複数選択可能にします。  
* **UX:** \- 選択された日付は bg-emerald-500 text-white で強調。  
  * カレンダーの下に「選択された日付のバッジリスト」をリアルタイム表示。バッジの x で削除可能。

### **6.2.3 時間枠の設定 (Section 3\)**

* **時間刻み (slot\_interval):**  
  * ToggleGroup または Tabs を使用。「15分 / 30分 / 60分」から選択。デフォルトは「30分」。  
* **共通時間範囲 (display\_start\_time / display\_end\_time):**  
  * 選択したすべての日付に適用される時間範囲を指定。  
  * Select コンポーネントを使用し、30分刻みのリスト（00:00〜23:30）から「開始」と「終了」を選択。

### **6.2.4 詳細オプション (Section 4 \- Accordion)**

デフォルトでは閉じており、必要に応じて展開する設定項目です。

* **Discord Webhook:** \- URL入力欄。入力された場合、events テーブルの webhook\_url に保存。  
* **回答締め切り (deadline\_at):**  
  * 日付と時間のピッカー。締め切りを過ぎると回答を自動ロックするロジックのフラグとなります。  
* **カスタム質問:**  
  * 「＋質問を追加」ボタンで入力行を増やす動的リスト。参加者へのアンケート項目として使用。

---

## **6.3 作成完了フロー**

### **6.3.1 バリデーション**

* title が空でないか。  
* selected\_dates が1つ以上選択されているか。  
* start\_time が end\_time より前か。

### **6.3.2 送信処理とDB登録**

1. events レコードを作成し、id と admin\_token を取得。  
2. 選択された各日付（例：2025-12-24）と時間設定に基づき、**time\_slots レコードを一括生成**。  
   * 例：9:00〜10:00、30分刻みなら、9:00と9:30の2つのスロットを生成。

### **6.3.3 作成完了モーダル (Success Dialog)**

作成に成功すると、画面遷移せずに以下の情報をモーダルで表示します。

* **「イベント作成完了！」のメッセージ**  
* **参加者用URL:** domain.com/events/\[id\]（コピーボタン付き）。  
* **管理者専用URL:** domain.com/events/\[id\]?token=\[admin\_token\]（「他人に教えないでください」の注意書き付き）。  
* **次のアクション:** 「自分の回答を入力する」ボタン。

---

次は **7\. 機能詳細 2：回答グリッド画面（/events/\[id\]）** の詳細を作成しますか？

# **7\. 機能詳細 2：回答グリッド画面（/events/\[id\]）**

参加者がイベントURLにアクセスした際に表示されるメイン画面です。回答者の名前入力を経て、直感的なグリッド操作へと誘導します。

---

## **7.1 STEP 1：チェックイン・モーダル (Name Entry)**

ページ読み込み時、回答者が特定されていない場合（LocalStorageにデータがない場合）に最前面に表示します。

* **デザイン:** bg-white の rounded-2xl モーダル。背景は強力な backdrop-blur-sm でぼかします。  
* **入力項目:**  
  * **お名前 (必須):** Input コンポーネント。参加者リストに表示される名前。  
  * **メールアドレス (任意):** 日程確定通知を受け取りたい人向け。  
* **アクション:**  
  * 「回答を始める」ボタン押下後、responses テーブルにレコードを作成し、返された id をブラウザの LocalStorage に保存します。  
  * 管理者トークンがURLに含まれている場合は、自動的に「管理者モード」としてチェックインします。

---

## **7.2 グリッド表示と視覚的フィードバック**

### **7.2.1 グリッド構造**

* **横軸 (X-axis):** 主催者が選択した日付（例：12/24 (水)）。  
* **縦軸 (Y-axis):** 15/30/60分単位の時間軸。  
* **ヘッダー固定:** スクロールしても「日付」と「時刻」のラベルは常に表示される sticky 配置。

### **7.2.2 色彩ロジック (Color Logic)**

* **自分の回答:** bg-emerald-500。自分が「空いている」とマークしたセル。  
* **ヒートマップ (他者の回答):** emerald-500 の不透明度を変更して重ねます。  
  * 0人: bg-transparent  
  * 1人以上: bg-emerald-500/10 〜 bg-emerald-500/90 (参加可能人数の割合に応じて線形に変化)  
* **確定範囲 (管理者):** border-2 border-pink-500 bg-pink-500/30。管理者が最終決定した範囲。

---

## **7.3 インタラクション詳細**

### **7.3.1 ホバー詳細表示 (PC) / タップ詳細 (Mobile)**

セルにフォーカスを当てた際、ツールチップまたはポップオーバーを表示します。

* **表示内容:**  
  * 「◯人中 ◯人が参加可能」  
  * **参加可能リスト:** 佐藤、鈴木、田中...（緑色で表示）  
  * **不参加リスト:** 高橋、伊藤...（薄いグレーで表示）

### **7.3.2 リアルタイム同期**

* 他の参加者が回答を更新した場合、画面をリロードせずにヒートマップが更新されるよう、Supabase の Realtime 機能を活用して availability テーブルの変更を監視します。

---

## **7.4 画面下部：アクションバー**

回答操作中、常に画面下部に固定される UI 要素です。

* **左側:** 現在のログイン名（例：「佐藤 さんとして回答中」）。  
* **右側:**  
  * **「再編集URLをコピー」ボタン:** LocalStorage が消えた際や別デバイス用のバックアップURL。  
  * **「保存/完了」ボタン:** 回答を確定し、サーバーへ同期。成功時に「保存しました」のトースト通知と、任意で編集リンクの案内を表示。

---

## **7.5 レスポンシブ対応の特記事項**

* **PC:** 左側に Sidebar（参加者リスト）、右側に Grid。  
* **Mobile:**  
  * Grid を全幅表示。  
  * 参加者リストは、画面上部の「◯人が回答済み」というバッジをタップすることで、下からスライドする Drawer として表示。  
  * 指一本で操作できるよう、グリッドの最小セルサイズを min-h-\[40px\] 以上に保ちます。

---

次は **8\. 技術仕様：グリッド操作ロジック** の詳細を作成しますか？

# **8\. 技術仕様：グリッド操作ロジック**

スマホでの「スイスイ動く」操作感と、PCでの直感的なドラッグ操作を両立させるための技術的要件です。ブラウザ標準の挙動（スクロールやズーム）を意図的に制御し、グリッド専用の入力系を構築します。

---

## **8.1 統合入力系 (Unified Pointer Events)**

マウス、タッチ、ペン全ての入力を単一のロジックで処理するため、Pointer Events API を全面的に採用します。

* **採用ハンドラ:**  
  * onPointerDown: 操作の開始。描画モード（選択 vs 解除）の決定。  
  * onPointerEnter: ドラッグ中のセル進入検知。  
  * onPointerUp: 操作の終了。DBへの一括同期トリガー。  
* **ポインターキャプチャ:** setPointerCapture を使用し、指がグリッドの外に出ても PointerUp を確実に検知します。

---

## **8.2 ドラッグ・選択アルゴリズム**

「なぞる」動作で複数のセルを効率的に処理するロジックです。

1. **モード判定:**  
   * 最初にタップ/クリックしたセルの状態で「塗りつぶしモード」か「消しゴムモード」かを決定します。  
2. **状態管理:**  
   * lastVisitedCellId を保持し、同じセルで何度も処理が走るのを防ぎます。  
3. **範囲の決定:**  
   * 回答モードでは「なぞったパス」を全て対象とします。  
   * 管理者確定モードでは「始点 $(x\_1, y\_1)$」と「終点 $(x\_2, y\_2)$」を結ぶ矩形範囲を計算します。  
   * 選択範囲 $S$ は、セル座標 $(i, j)$ において次を満たす集合です：  
     $$S \= \\{ (i, j) \\mid \\min(x\_1, x\_2) \\le i \\le \\max(x\_1, x\_2) \\land \\min(y\_1, y\_2) \\le j \\le \\max(y\_1, y\_2) \\}$$

---

## **8.3 スクロールとビューポートの制御 (Mobile Priority)**

スマホでドラッグ中に画面が上下に動くのを防ぐための厳格な制御です。

* **CSS制御:**  
  * グリッドコンテナに対して touch-action: none; を適用。これによりブラウザ標準のスクロール、ピンチズーム、スワイプを完全に封鎖します。  
  * user-select: none; を適用し、テキスト選択が走らないようにします。  
* **動的オーバーフロー制御:**  
  * ドラッグ開始（PointerDown）時に document.body.style.overflow \= 'hidden' を適用し、ドラッグ終了時に解除します。

---

## **8.4 パフォーマンスとレンダリング最適化**

数百個のセルがあるグリッドにおいて、毎フレームの再描画負荷を最小限に抑えます。

* **React.memo の活用:**  
  * 各 Cell コンポーネントを React.memo でラップし、プロパティ（選択状態、ヒートマップの不透明度）に変更がない限り再描画をスキップします。  
* **仮想的な描画状態:**  
  * ドラッグ中の「色の変化」は、グローバルな状態（DB/Context）を更新するのではなく、CSSクラスの直接操作や、軽量なローカルStateで反映させ、PointerUp 時のみ重い処理（サーバー同期）を実行します。  
* **レンダリング層の分離:**  
  * 背景のヒートマップ層、自分の回答層、管理者のピンクオーバーレイ層を z-index で分け、変更があった層のみを更新対象とします。

---

## **8.5 触覚フィードバック (Haptic Feedback)**

操作に物理的な感触を与えることで、入力の確実性を向上させます。

* **振動パターン:**  
  * 新しいセルに進入（onPointerEnter）し、状態が変化した瞬間に window.navigator.vibrate(8) を実行します。  
  * これにより、指でなぞるたびに「トトトト」という微細な振動が伝わり、アナログなボタンを押しているような感覚を演出します。

---

## **8.6 管理者用：矩形選択（ピンクモード）特有の挙動**

* **オーバーレイ追従:**  
  * 指を動かしている間、始点と現在地を対角線とする div 要素（bg-pink-500/40）を絶対座標で動的にリサイズして表示します。  
* **座標変換:**  
  * PointerEvent の clientX/Y を getBoundingClientRect でグリッド内の相対座標に変換し、どのインデックスのセルが選択範囲に含まれるかを算出します。

---

次は **9\. 機能詳細 3：管理者用設定パネル** の詳細を作成しますか？

# **9\. 機能詳細 3：管理者用設定パネル**

管理者がイベントの運用ルールを制御し、Discord 連携やリマインド設定をカスタマイズするための専用インターフェースです。

---

## **9.1 アクセス権限と認証**

* **管理者URL:** domain.com/events/\[id\]?token=\[admin\_token\]。  
* **認証ロジック:** URL パラメータの token が events テーブルの admin\_token と一致する場合のみ、管理者用 UI 要素を表示し、API 操作を許可します。  
* **表示属性:** 回答者リスト（サイドバー）において、管理者の名前の横には emerald-500 または slate-900 のバッジで「Admin」と明記します。

---

## **9.2 管理者ダッシュボードのレイアウト**

回答画面のメイン UI を邪魔しないよう、右サイドバーまたはアコーディオン形式のフローティングパネルとして実装します。

* **デザイン:** bg-white/95 backdrop-blur shadow-2xl border-l border-slate-200。  
* **構成要素:**  
  * **基本編集エリア:** イベント名、説明文の変更。  
  * **Discord 設定エリア:** 通知トリガーの詳細制御。  
  * **スケジュール管理エリア:** 締め切り設定とリマインドの自動化。

---

## **9.3 Discord 連携詳細設定 (Discord Config)**

Webhook を介した通知の挙動を、管理者が細かくパーソナライズできます。

* **Webhook URL 管理:**  
  * 入力・更新・テスト送信機能。  
* **通知トリガーのトグル (Switch):**  
  * **日程確定通知:** 予定を最終決定した際に送信。  
  * **日程変更通知:** 確定済みの予定を修正・再確定した際に送信。  
* **通知コンテンツのプレビュー:**  
  * 送信される Embed（カード）の内容を管理画面上で確認可能にします。

---

## **9.4 リマインド・スケジューラー (Reminder Settings)**

回答を促す自動通知のタイミングを設定します。

* **設定項目:**  
  * **リマインド実行タイミング:** 「締め切りの ◯ 時間前」という数値を 1 刻みで入力可能。  
  * **ターゲット:** 未回答者、または回答が「空欄」のままの参加者。  
* **技術的実行:**  
  * events テーブルの reminder\_hours カラムに保存。  
  * 外部サービス（cron-job.org）からエンドポイント /api/cron/remind が叩かれた際、現在時刻と「締め切り \- reminder\_hours」を比較し、条件に合致すれば Discord へ投稿します。

---

## **9.5 イベントの動的変更とロック制御**

* **回答の締め切り設定:**  
  * deadline\_at を設定し、カレンダーピッカーで日時を指定。  
* **締め切り後の挙動:**  
  * 管理者パネルから「回答をロックする」を手動で実行することも可能。  
  * ロック中、一般参加者の画面ではグリッドが pointer-events-none opacity-80 となり、閲覧専用に切り替わります。  
* **後出し編集の許可:**  
  * 管理者設定により、「日程確定後も参加者が回答を修正できるか」をトグルで切り替え可能（デフォルトは「許可」）。

---

## **9.6 管理操作のセキュリティ**

* すべての更新リクエスト（POST/PATCH）は、リクエストボディに admin\_token を含める必要があります。  
* Supabase の RLS (Row Level Security) を使用し、有効なトークンを持たないユーザーによる events テーブルの更新をサーバーサイドで拒否します。

---

次は **10\. 機能詳細 4：予定確定（ピンクモード）と再編集** の詳細を作成しますか？

# **10\. 機能詳細 4：予定確定（ピンクモード）と再編集**

管理者が集計されたヒートマップを元に、最終的な開催日時を決定するためのコア・インターフェースです。直感的な「矩形選択（ボックス選択）」により、複数の時間枠を一括で確定状態にします。

---

## **10.1 予定確定モード（Schedule Mode）の起動**

管理者パネル内にある「Schedule Mode」のトグルスイッチをONにすることで、グリッドが回答モードから確定モードへ切り替わります。

* **視覚的変化:**  
  * グリッド全体の彩度がわずかに下がり、背面のヒートマップ（エメラルド色）が少し控えめな表示になります。  
  * カーソルが十字（crosshair）に変化し、範囲選択が可能であることを示唆します。

---

## **10.2 矩形選択（ピンクオーバーレイ）のUI/UX**

マウスまたは指のドラッグにより、開始点から終了点までの範囲を視覚的に選択します。

* **オーバーレイのデザイン:**  
  * 選択範囲を bg-pink-500/40 （半透明のピンク）の div 要素で覆います。  
  * 枠線には border-2 border-pink-500 を適用し、選択範囲を際立たせます。  
* 計算ロジック:  
  ドラッグ中の始点 $(x\_1, y\_1)$ と現在点 $(x\_2, y\_2)$ から、包含されるセル ID のリストを以下の式で抽出します。  
  $$SelectedCells \= \\{ Cell(i, j) \\mid \\min(x\_1, x\_2) \\le i \\le \\max(x\_1, x\_2) \\land \\min(y\_1, y\_2) \\le j \\le \\max(y\_1, y\_2) \\}$$

---

## **10.3 リアルタイム・マッチング集計**

範囲を選択している間、その範囲の「開催可能性」を即座に計算して表示します。

* **集計バッジの表示:**  
  * ピンクのオーバーレイの右端または下端にフローティングバッジを表示。  
  * **表示内容:** 「◯人中 ◯人が参加可能（◯％）」  
* **欠席者の可視化:**  
  * サイドバーの参加者リストにおいて、選択範囲に「不可」を出しているユーザーのアイコンを半透明にする、あるいは「×」マークを付与することで、誰を切り捨てることになるかを瞬時に判断させます。

---

## **10.4 予定の確定（Finalize）**

範囲を決定し「この日程で確定」ボタンを押した際の処理です。

1. **DB更新:** events テーブルの confirmed\_start\_at と confirmed\_end\_at カラムを選択された範囲の開始・終了時刻で更新します。  
2. **ステータス変更:** イベント全体に is\_confirmed \= true フラグ（仮想）が立ち、参加者画面に「確定」バッジと詳細情報が表示されるようになります。  
3. **自動通知:** 設定に基づき、Discord Webhook へ確定通知をリクエストします。

---

## **10.5 再編集と再確定のロジック**

「一度決めたが、主要メンバーが急遽来られなくなった」等のケースに対応するための柔軟な設計です。

* **再編集の許可:**  
  * 確定後も管理画面には「予定を再編集する」ボタンを常設します。  
  * これを押すと、以前の confirmed 期間がリセット（あるいは上書き待機状態）され、再びピンクの矩形選択が可能になります。  
* **参加者の回答修正（後出し編集）:**  
  * 今回の仕様では「確定後も参加者の回答修正を許可」するため、参加者が回答を更新した結果、確定済みのピンクの範囲内の「参加可能人数」が変動する場合があります。  
  * この場合、管理画面では「確定済みの枠に変動がありました」というアラートを出し、再検討を促します。  
* **再確定時の通知:**  
  * 再確定が行われた場合、Discord 通知のタイトルを 【日程変更】 とし、以前の決定が更新されたことを明示します。

---

次は **11\. 機能詳細 5：確定後のおもてなしと外部連携** の詳細を作成しますか？

# **11\. 機能詳細 5：確定後のおもてなしと外部連携**

管理者が予定を確定（または再確定）した直後、参加者と主催者の双方に提供される利便性の高いツール群の定義です。単なる「調整終了」で終わらせず、その後の行動（カレンダー登録や共有）をシームレスに支援します。

---

## **11.1 確定後の画面表示 (Finalized View)**

予定が確定したイベントページでは、グリッドの上部に「確定済みセクション」が追加され、最優先情報として表示されます。

* **ビジュアル:**  
  * bg-emerald-50 border border-emerald-200 rounded-2xl p-6 mb-8  
  * 大きなチェックマーク（CircleCheck アイコン）と、確定した日時を text-2xl font-bold で表示。  
* **ステータス:**  
  * グリッド内の確定範囲がピンク色で恒久的にハイライトされます。  
  * 再編集が許可されているため、回答者は引き続き自分の予定を更新可能ですが、確定セクションには「現在◯人が参加予定」とリアルタイムの出席状況が表示されます。

---

## **11.2 ワンタップ・カレンダー登録 (Calendar Integration)**

確定した日程を自分のカレンダーへ即座に転記するための機能です。

### **11.2.1 Google カレンダー登録**

* ロジック: API 連携は不要。以下の形式の URL スキームを生成し、新規タブで開きます。  
  https://www.google.com/calendar/render?action=TEMPLATE\&text=\[イベント名\]\&details=\[説明URL\]\&dates=\[開始時刻(UTC)\]/\[終了時刻(UTC)\]  
* **UI:** Google カレンダーのブランドカラー（または emerald-500）のボタンを配置。

### **11.2.2 Apple / Outlook 用 iCal 形式 (.ics)**

* **ロジック:** ブラウザ上で動的に .ics ファイルを生成（Blob オブジェクトを使用）し、ダウンロードさせます。  
* **データ構造:**  
* Plaintext

BEGIN:VCALENDAR  
VERSION:2.0  
BEGIN:VEVENT  
SUMMARY:\[イベント名\]  
DTSTART:\[YYYYMMDDTHHMMSSZ\]  
DTEND:\[YYYYMMDDTHHMMSSZ\]  
DESCRIPTION:MogiMeetで調整された予定です。 \[URL\]  
END:VEVENT  
END:VCALENDAR

*   
* 

---

## **11.3 共有用テキスト生成 (Copy to Clipboard)**

LINE、Slack、Discord などの SNS へ決定事項を報告するための「コピー用テキスト」を 1 クリックで生成します。

* **生成テキスト例:**  
  🎊 【MogiMeet】日程が確定しました！  
  イベント: \[イベント名\]  
  日時: 12月24日(水) 19:00 〜 21:00  
  参加者: 佐藤, 鈴木, 田中 (計3名)  
  詳細を確認する: \[URL\]  
* **UI:** 「テキストをコピー」ボタン。コピー成功時に Sonner で「コピーしました」のトーストを表示。

---

## **11.4 Discord 最終リポート通知 (Final Report)**

管理者が「確定」ボタンを押した際、設定された Webhook URL に対してリッチな通知（Embed）を送信します。

* **Embed 構成:**  
  * **Title:** 🎊 日程決定: \[イベント名\]（再確定時は ⚠️ 日程変更: \[イベント名\]）  
  * **Description:** 確定した日時の範囲と、現在の参加可能人数を記載。  
  * **Fields:** \* 日時: 2025/12/24 19:00 \- 21:00  
    * 出席: 佐藤, 鈴木, 田中  
  * **Color:** 確定時は 0x10B981 (Emerald)、再確定時は 0xEC4899 (Pink)。  
  * **Footer:** MogiMeet \- スイスイ調整、パッと決定。  
* **アクション:** 下部にイベントページへのリンクボタンを配置（Discord のコンポーネント機能）。

---

## **11.5 再編集（リカバリー）時の挙動**

管理者が確定済みの予定を修正した場合、以下の「おもてなし」が自動で再発動します。

* 画面上の確定セクションの内容が新日時に即座に書き換わる。  
* Discord へ「日程変更」の Embed が再投稿される。  
* 以前発行されたカレンダー登録用 URL も、新日時に基づいて再生成される。

---

次は **12\. 通知・自動化システム** の詳細を作成しますか？

# **12\. 通知・自動化システム**

「MogiMeet」の運用負荷を下げ、参加者の回答率を向上させるためのバックエンド通知ロジックと、サーバーレス環境での自動実行システムの定義です。

---

## **12.1 Discord Webhook 連携**

サーバーサイドから Discord へリッチな Embed（カード形式メッセージ）を送信する仕組みです。

* **送信トリガー:**  
  1. **日程確定時:** 管理者がピンクモードで範囲を決定し「確定」を実行した際。  
  2. **日程変更時:** 確定済みの予定を管理者が上書き保存した際。  
  3. **自動リマインド:** 外部 Cron 実行により、設定された条件を満たした際。  
* **通知の構造 (Payload):**  
* JSON

{  
  "embeds": \[{  
    "title": "🎊 日程決定: \[イベント名\]",  
    "description": "以下の時間でミートが決定しました！",  
    "color": 673435,  
    "fields": \[  
      { "name": "確定日時", "value": "12/24(水) 19:00 \- 21:00", "inline": false },  
      { "name": "参加メンバー", "value": "佐藤, 鈴木, 田中", "inline": false }  
    \],  
    "footer": { "text": "MogiMeet | スイスイ調整、パッと決定。" }  
  }\],  
  "components": \[{  
    "type": 1,  
    "components": \[{  
      "type": 2, "label": "イベントページを開く", "style": 5, "url": "\[Event URL\]"  
    }\]  
  }\]  
}

*   
* 

---

## **12.2 自動リマインド・ロジック**

回答を忘れているメンバーに対し、締め切り前に自動で催促を行うシステムです。

* **実行判定条件:**  
  * events.webhook\_url が登録されていること。  
  * events.reminder\_hours が設定されていること。  
  * 現在時刻が deadline\_at（締め切り日時）から reminder\_hours を引いた時刻を過ぎていること。  
  * 既にリマインド済み（is\_reminded フラグ等）でないこと。  
* **リマインド内容:**  
  * **メッセージ:** 「回答締め切りまで残り ◯ 時間です。まだ回答していない方は、以下のリンクから入力をお願いします！」

---

## **12.3 API エンドポイント (/api/cron/remind)**

外部の Cron サービスから定期的に叩かれる、リマインド処理専用の Edge Function です。

* **処理フロー:**  
  1. **認証:** リクエストヘッダーの Authorization: Bearer \[CRON\_SECRET\] を検証。  
  2. **抽出:** 「現在時刻」と「各イベントのリマインド予定時刻」を照合し、対象となる events レコードを取得。  
  3. **実行:** 対象イベントの Webhook URL に対して Discord 通知を送信。  
  4. **記録:** 二重送信防止のため、当該イベントの last\_reminded\_at カラムを更新。

---

## **12.4 セキュリティ（Cron Secret）**

不特定多数からの API 実行を防ぐための保護策です。

* **仕組み:** 環境変数 CRON\_SECRET を定義。  
* **検証:** API 側で受信したトークンと環境変数が一致しない場合は 401 Unauthorized を返し、処理を中断します。

---

## **12.5 cron-job.org の設定要件**

自動実行のトリガーとして外部サービスを利用します。

* **URL:** https://your-app.vercel.app/api/cron/remind  
* **実行頻度:** 1時間ごと（あるいは30分ごと）。  
* **カスタムヘッダー:** Authorization: Bearer \[あなたのCRON\_SECRET\] を設定。  
* **タイムアウト:** 30秒（Next.js Edge Function の制限内）。

---

## **12.6 カレンダー登録リンク生成 (URL Helper)**

通知メッセージ内に含まれる Google カレンダー登録用 URL の生成ロジックです。

* **関数:** generateGoogleCalendarUrl(event)  
* **入力:** イベント名、開始時刻、終了時刻、イベントURL。  
* **出力:** https://calendar.google.com/calendar/render?action=TEMPLATE\&text=... 形式のエンコード済み文字列。

---

次は **13\. AIへの実装ステップ指示（ロードマップ）** の詳細を作成しますか？

# **13\. AIへの実装ステップ指示（ロードマップ）**

このセクションは、AI（Antigravity, Cursor, Gemini 等）に対して、開発の優先順位と段階的な実装手順を指示するためのガイドラインです。一度にすべてを実装しようとせず、以下のフェーズに分けて段階的にプロンプトを投入することを推奨します。

---

## **13.1 フェーズ 1：インフラ構築と DB セットアップ**

**目標:** データが保存・取得できる最小限のバックエンドを構築する。

1. **SQL 実行:** セクション 3 で定義した SQL スキーマを Supabase の SQL Editor で実行し、テーブル、リレーション、インデックスを作成する。  
2. **プロジェクト初期化:** npx create-next-app@latest を実行し、Tailwind CSS, TypeScript, App Router を有効にする。  
3. **環境変数設定:** .env.local に Supabase の接続情報を設定する。  
4. **Supabase Client:** @supabase/supabase-js をインストールし、サーバー/クライアント両方で使えるクライアント定義を作成する。

## **13.2 フェーズ 2：イベント作成画面 (/create) の実装**

**目標:** 候補日を選択し、データベースへ保存してイベント URL を発行する。

1. **shadcn/ui の導入:** Calendar, Input, Button, Card 等のコンポーネントをインストールする。  
2. **フォーム構築:** セクション 6 に基づき、イベント名、説明、特定日付選択（mode="multiple"）を実装。  
3. **サーバーアクション:** フォーム送信時に events と time\_slots テーブルへデータを挿入するロジックを実装。  
4. **完了画面:** 参加者用 URL と管理者用 URL を表示するモーダルを作成。

## **13.3 フェーズ 3：回答グリッドの核となるインタラクション**

**目標:** 「スイスイ動く」グリッド回答体験を実現する。

1. **チェックイン機能:** ページ読み込み時に名前入力を求めるモーダルを実装。responses テーブルへの保存と LocalStorage への ID 記録を行う。  
2. **グリッド描画:** display: grid を使用し、時間軸と日付軸を正確にレンダリングする。  
3. **Pointer Events 実装:** セクション 8 に基づき、ドラッグによる一括選択・解除を実装。touch-action: none によるスクロール制御を徹底する。  
4. **ハプティクス:** navigator.vibrate によるフィードバックを追加。  
5. **ヒートマップ:** 他のユーザーの回答をリアルタイムで集計し、不透明度による階層表示を行う。

## **13.4 フェーズ 4：管理者モードと予定確定ロジック**

**目標:** ピンクの矩形選択で日程を最終決定する。

1. **管理者認証:** URL のトークンを確認し、管理者パネルを表示する。  
2. **ピンクモード実装:** ドラッグの始点と終点から矩形範囲を算出し、confirmed\_start\_at / confirmed\_end\_at を更新するロジックを実装。  
3. **マッチング集計:** 選択範囲内の参加可能人数をリアルタイムにバッジ表示する。  
4. **再編集フロー:** 確定後の状態から再び確定モードに戻るステート管理を実装。

## **13.5 フェーズ 5：Discord 連携と自動リマインド**

**目標:** 外部サービスと連携し、ユーザーへ通知を届ける。

1. **Discord Webhook 発信:** 日程確定・変更時に、セクション 12 の形式で Embed を送信する API ルートを作成。  
2. **カレンダー連携:** 確定日時に基づく Google カレンダー URL と .ics 生成ロジックの実装。  
3. **リマインド API:** /api/cron/remind エンドポイントを作成し、署名検証と条件判定を行うロジックを構築。

## **13.6 フェーズ 6：最終調整とデプロイ**

**目標:** 本番環境への公開と品質向上。

1. **レスポンシブ最適化:** スマホでのボタン配置、ドロワーメニューの動作確認。  
2. **エラーハンドリング:** DB 接続エラーや Webhook 失敗時のユーザーフィードバック（Toast）を追加。  
3. **Vercel デプロイ:** GitHub 連携を行い、環境変数を設定して本番環境へ公開。  
4. **Cron ジョブ登録:** cron-job.org に API エンドポイントを登録。

---

以上で「MogiMeet」の全仕様書の作成が完了しました。

すべての項目を MD ファイルにまとめ、フェーズ 1 から順に AI に渡して開発を進めてください。

素晴らしいツールが完成することを願っております！

ettucemeetの画像を渡す際、ただ見せるだけでなく、**どこを参考にしてほしいか**を言葉で補足してください。

**画像と一緒に送るメッセージ例:** 「添付したLettucemeetの画像を参考にしてください。特に以下の点をMogiMeetに反映させたいです。

1. **ヒートマップの色の濃淡:** 人数が多いほど濃い緑になる視覚効果。  
2. **ピンクの確定範囲:** 管理者がドラッグした時のピンク色の半透明オーバーレイの質感。  
3. **グリッドの密度:** PCで見た時のスッキリとした清潔感のあるレイアウト。」

## **4\. 最初のプロンプトの「締めくくり方」**

一度に全コードを出力させようとすると、AIの記憶容量（コンテキスト）が足りなくなり、後半のコードが雑になります。以下の指示で締めくくるのがコツです。

**「まずは、プロジェクトのディレクトリ構造の提案と、データベース（SQL）の最終確認から始めてください。コードを一気に書かずに、ステップごとに確認を求めながら進めてください。」**

**1ファイルに詰め込みすぎないで」:**

* AIは楽をしようとして、1つの大きなファイルに全てのロジックを書く傾向があります。「コンポーネントを `components/ui` や `components/event` に適切に分割して、可読性と保守性を高めて」と指示してください。

**「スマホのスクロール制御を徹底して」:**

* 「グリッド操作中に画面が動いてしまうのは、このアプリで最も避けるべきユーザー体験（UX）の欠陥です。`touch-action: none` だけでなく、イベントの `preventDefault()` を適切に処理するように強く指示してください」と念押ししてください。

**「型安全（TypeScript）を厳格に」:**

* 「Any型を使わず、Supabaseの生成された型定義や、独自に定義した Interface を使って、型安全なコードを書いて」と伝えてください。

